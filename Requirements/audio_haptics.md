# Audio & Haptics Requirements (2026-02-24)

## Goals
- Consistent pulse feedback:
  - `Retro audio` mode:
    - Grid tick plays an arpeggio using the three-lane safe pattern.
    - Left/right move plays a distinct lane-confirmation pulse using the middle-lane timbre.
    - Light impact haptic still fires on every left/right move and every grid tick.
  - Cue modes (`chord`, `arpeggio`, `lane pulses`): replace `bip` with generated lane cues.
- Crash feedback: play `fail` sound and trigger error haptic immediately on collision; crash sprite flashes while the sound plays.
- Safe start: game remains paused while `start` sound plays (initial launch and post-crash resume), then unpauses automatically at completion.
- Exiting the game stops any playing sounds with a very short fade-out.
- User control in Settings:
  - SFX volume slider (0â€“100%).
  - Audio feedback mode selector (display order: `Retro`, `Audio cues (lane pulses)`, `Audio cues (arpeggio)`, `Audio cues (chord)`).
  - Lane-change cue style selector (`Lane confirmation`, `Success`, `Lane + success`, `Haptics`).
  - Speed increase warning feedback selector (`VoiceOver announcement`, `Haptic`, `Sound`, `None`).

## Implementation Rules
- Shared audio abstraction `SoundEffectPlayer`; injected into `GameScene` (no defaults in initializers).
- Primary runtime SFX path uses `AVGeneratedSoundEffectPlayer` (generated PCM for `start`, `bip`, `fail`) with a modular `GeneratedSFXProfile`/recipe model.
- Generated SFX recipes are composed from ordered segments (`intro`, `body`, optional repeated `tailPattern`) so tuning is code-only constant edits.
- `GeneratedSFXProfile.failTailRepeatCount` is the one-line fail-tail repetition knob; default is baseline minus one repeat to shorten fail feedback.
- Fallback runtime path uses `FallbackSoundEffectPlayer` + bundled-asset `AVSoundEffectPlayer` for resilience when generated playback is unavailable.
- Shared cue abstraction `LaneCuePlayer` with AVFoundation implementation `AVLaneCuePlayer`; injected into `GameScene` and backed by generated PCM buffers (no prerecorded cue assets required).
- Sound IDs remain `start`, `bip`, `fail`; `.m4a` assets remain in the shared bundle as fallback only.
- Generated + asset players both use a small `bip` pool so rapid tick/move pulses do not restart and get dropped.
- `GameScene` uses `SoundEffectPlayer` for start/fail. Tick/move guidance uses `LaneCuePlayer` in cue modes and also in retro mode for distinct tick/move timbres.
- Cue mode behavior:
  - Tick cue: announce currently safe columns in the row directly ahead of the player.
  - Move cue style:
    - `Lane confirmation`: destination lane only.
    - `Success`: safe/unsafe indicator only.
    - `Lane + success`: destination lane followed by safe/unsafe indicator as two quick notes.
    - `Haptics`: no lane audio move cue; trigger success haptic for safe destination and regular move haptic for unsafe destination.
- Move haptics:
  - Default path: triggered by touch/remote adapters immediately when left/right input is handled.
  - Exception: when cue mode is active and lane style is `Haptics`, adapters suppress immediate move haptic and `GameScene` emits safe/unsafe-specific haptic.
- Crash haptic is triggered in `handleCrash` immediately; collision resolution completes on fail-sound completion with an 8s fallback if completion is missing.
- Start/resume keeps `gameState.isPaused == true` until `start` sound completion sets it to false; on post-crash resume the player-car grid is rendered immediately (no lingering crash sprite), and a 2s fallback unpauses if completion is missing.
- App bootstrap listens to audio session interruption/route/media-reset notifications and re-activates the session.
- SFX volume persistence uses `ConditionalDefault<SoundEffectsVolumeSetting>` (`sfxVolume_conditionalDefault`):
  - VoiceOver ON system default: `1.0`
  - VoiceOver OFF system default: `0.8`
  - User slider changes store explicit override and always win after migration.
- Speed warning feedback persistence uses `ConditionalDefault<SpeedWarningFeedbackMode>` (`speedWarningFeedbackMode_conditionalDefault`) resolved through `SpeedWarningFeedbackPreference`:
  - VoiceOver OFF default: `none`
  - VoiceOver ON + haptics supported default: `warningHaptic`
  - VoiceOver ON + haptics unsupported default: `announcement`
  - User override always wins.
- Migration (`SettingsPreferenceMigration`):
  - Legacy `inGameAnnouncementsEnabled == true` -> `announcement`
  - Legacy `false` -> `none`
  - Legacy `sfxVolume` seeds conditional default override
  - Runs once via migration marker key.
- Audio feedback mode persists via `ConditionalDefault<AudioFeedbackMode>` (`audioFeedbackMode_conditionalDefault`): VoiceOver-adaptive default is `lane pulses` where VoiceOver status is available.
- Lane move cue style persists via `UserDefaults` key `laneMoveCueStyle`.
- In-game/tutorial preview playback uses `LaneCuePlayer` with the current SFX volume and must call `stopAll` on dismiss so previews never leak into gameplay.
- Settings and tutorial include `Preview warning` for speed increase warning feedback; preview behavior matches gameplay for all four modes.
- Tutorial apply actions for audio mode, lane cue style, and speed increase warning feedback switch to a disabled `X configured` state when preview selection already matches the stored setting.
- Settings + watch Settings hide the `Audio cue tutorial` entry when selected audio mode is `Retro audio`.
- In-game help hides audio-cue tutorial sections when selected audio mode is `Retro audio` and only shows speed-warning tutorial content when the configured speed-warning mode is not `None`.
- Settings disable `Preview warning` when mode is `None`, and also when mode is `VoiceOver announcement` while VoiceOver is currently off.
- Haptics respect existing toggle (`hapticFeedbackEnabled`).
- Platform policy:
  - macOS and tvOS do not expose haptics options.
  - Lane style `Haptics` option is filtered out where haptics are unsupported.
  - Speed increase warning feedback uses `AccessibilityNotification.Announcement` for announcement mode on all platforms.
  - Speed increase warning announcement mode posts with high announcement priority.
  - Speed increase warning `Haptic` mode triggers two consecutive warning haptic events.
  - Speed increase warning sound uses a dedicated generated cue (`D4-F4-A4`, repeated twice) and does not reuse lane-safe tick cues.

## Testing Expectations
- Unit tests cover: generated-player completion/volume/stop behavior; recipe modularity (including fail-tail repeat count impact); fallback routing to asset player when generated playback is unavailable; retro tick arpeggio + retro move middle-lane routing; cue-mode routing for tick and move cues; lane move cue style forwarding (including `Haptics` safe/unsafe behavior); paused move input behavior; fail sound + crash haptic on collision; crash fallback fires once when completion is missing; start/resume pauses until sound completion with fallback and restores player visuals immediately after crash; stopAll invoked when game view disappears; volume changes propagate to both `SoundEffectPlayer` and `LaneCuePlayer`; conditional-default/override resolution and migration for audio/speed warning settings.
