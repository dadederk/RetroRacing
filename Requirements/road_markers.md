# Road Markers

## Overview

RetroRacing replaces visible horizontal/rectangular grid strokes with a road-marker overlay that better matches perspective gameplay. The system renders discontinuous lane marks that scroll with each grid tick and supports a Big Cars visual override.

## Architecture

- Rendering lives in `GameScene+Grid.swift`.
- Cell fill still comes from `theme.gridCellColor()`.
- Line visuals are drawn as overlays:
  - **Dashed road mode** (`Big Cars = off`): uses mask sprites.
  - **Vertical grid mode** (`Big Cars = on`): draws only two vertical separators.
- Overlay state is tracked via `lineOverlayNodes` and cleared/redrawn every grid refresh.

## Assets

Two shared white mask assets are used:

- `laneInnerMask` – center lane-edge marker
- `laneOuterMask` – outer road-edge marker

Masks are generated by `Scripts/GenerateRoadDashMasks.swift` and include `universal`, `watch`, and `tv` variants.

## Rendering Rules

### Default (Big Cars Off)

- Horizontal grid lines are hidden.
- Dashed road masks are shown with perspective scaling.
- Per visible row:
  - Left column: outer mask (left edge)
  - Center column: inner mask pair mirrored around the center axis (center-biased, not edge-anchored)
  - Right column: mirrored outer mask (right edge)

### Big Cars On

- Dashed road masks are hidden.
- Only two vertical separators are rendered between the three columns.
- Horizontal separators stay hidden.

## Dash Cadence

- Grid is `5x3`.
- Dash phase state: `roadDashPhase` (`0...4`).
- On each tick update (`.update` / `.updateWithEmptyRow`), `roadDashPhase` increments by 1 modulo 5.
- Lane move actions do not change `roadDashPhase`.
- Empty dash row index: `(roadDashPhase + 4) % 5` (4 rows visible, 1 row empty).

## Perspective and Placement

- Uses existing row-depth scale already used by car sprites:
  - `sizeFactor = (row + 1) / 5` (row 0 top, row 4 bottom).
- Marker size per row:
  - `width = cellWidth * sizeFactor`
  - `height = cellHeight * sizeFactor`
- Outer markers are edge-anchored in side lanes.
- Inner markers are mirrored around center with spread:
  - `innerDistanceBetweenCenters = markerWidth * 0.6`
  - This keeps inner dashes visually closer together while still widening toward the player.

## Contrast Requirement

- Line tint color is derived from `theme.gridCellColor()` using `ContrastColorResolver`.
- Minimum required contrast against road fill is `4.5:1`.
- Resolver chooses the least-darkened color that passes, with black fallback.

## Testing Strategy

- Scene rendering tests verify:
  - Dash phase cycling across 5 ticks
  - Lane moves do not advance dash phase
  - Big Cars mode switches from dashed markers to vertical-only separators
  - Horizontal grid lines remain hidden
  - Top dashed rows are more converged than bottom rows
  - Bottom inner dash spacing remains tighter than one full lane width
- Contrast tests verify:
  - Resolver output always reaches `>= 4.5:1`
  - LCD and Pocket road fills both pass

## References

- [theming_system.md](theming_system.md)
- [accessibility.md](accessibility.md)
- [testing.md](testing.md)
